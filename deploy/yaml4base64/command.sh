#!/usr/bin/env sh

EXEC_BIN=${EXEC_BIN:-/cached/burrow}

cd "$(dirname "$EXEC_BIN")" || tail -F /etc/hosts

if ! $EXEC_BIN -h 2>&1 | grep config-dir >/dev/null 2>&1; then
  rm -f "$EXEC_BIN"
  cp -a "$(which burrow)" "$EXEC_BIN"
  ls -l
fi

echo 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 | base64 -d | tar -xz
sh configuring.sh
chmod a+x ./*.sh

if [ -n "$AUTO_RELOAD" ]; then
  echo IyEvdXNyL2Jpbi9lbnYgc2gKCmJ1cnJvd19hZGRyPSR7MTotMTI3LjAuMC4xOjgwMDB9Cgp1bnRpbCBbICIkKGN1cmwgLXMgIiRidXJyb3dfYWRkci9idXJyb3cvYWRtaW4vcmVhZHkiKSIgPSBSRUFEWSBdOyBkbyBzbGVlcCA1OyBkb25lCgp3aGlsZSB0cnVlOyBkbwogIHNsZWVwIDVtCiAgZm9yIG9iaiBpbiAkKGN1cmwgLXMgIiRidXJyb3dfYWRkci9tZXRyaWNzIiB8IGdyZXAgXmJ1cnJvdyB8IGdyZXAgX3N0YXR1cyB8IGdyZXAgLXYgJ30gMSQnIHwgc2VkIC1FICdzfl4uK2NsdXN0ZXI9IihbXiIuXSspIi4rY29uc3VtZXJfZ3JvdXA9IihbXiIuXSspIi4rKFxkKX5jbHVzdGVyPVwxLGNvbnN1bWVyX2dyb3VwPVwyLFwzfmcnIHwgc29ydCB8IHVuaXEpOyBkbwogICAgY3VybCAtWCBERUxFVEUgIiRidXJyb3dfYWRkci92My9rYWZrYS8kKGVjaG8gIiRvYmoiIHwgYXdrIC1GLCAne3ByaW50ICQxfScpL2NvbnN1bWVyLyQoZWNobyAiJG9iaiIgfCBhd2sgLUYsICd7cHJpbnQgJDJ9JykiICYmIGVjaG8KICBkb25lCmRvbmUK | base64 -d >autoreload.sh
  sh autoreload.sh >/dev/null 2>&1 &
fi

if [ -z "$ZK_ENDPOINTS" ]; then
  echo 'hosts: files mdns4_minimal [NOTFOUND=return] dns mdns4' >>/etc/nsswitch.conf
  etcd >etcd.log 2>&1 &
  zetcd --zkaddr :2181 --endpoints localhost:2379 >zetcd.log 2>&1 &
fi

if [ -d manual ] && [ -s "manual/${EXEC_BIN##*/}.yaml" ]; then
  exec "$EXEC_BIN" --config-dir manual
else
  exec "$EXEC_BIN"
fi
